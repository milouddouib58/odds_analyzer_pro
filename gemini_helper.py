# gemini_helper.py
import os
import json
import google.generativeai as genai

def _configure_gemini():
    key = os.getenv("GEMINI_API_KEY")
    if not key: raise ValueError("GEMINI_API_KEY is not set.")
    genai.configure(api_key=key)

def analyze_with_gemini(payload: dict, model_name: str = "gemini-1.5-flash", temperature: float = 0.6) -> str:
    _configure_gemini()
    model = genai.GenerativeModel(model_name)
    json_blob = json.dumps(payload, ensure_ascii=False, indent=2)
    
    prompt = f"""
    أنت خبير ومستشار عالمي في استراتيجيات المراهنات الرياضية. اسمك "الاستراتيجي". مهمتك ليست مجرد تحليل البيانات، بل تقديم استشارة عميقة، تصحيح الأخطاء الشائعة، وإعطاء رأي خبير مبني على مقارنة بين تحليلين مختلفين.

    ستصلك بيانات JSON تحتوي على تحليلين:
    1.  `market_analysis`: تحليل مبني على أسعار السوق (الأموال). يوضح رأي السوق وأي فرص قيمة (value) وجدها.
    2.  `statistical_analysis`: تحليل مبني على نموذج بواسون الإحصائي. يوضح النتيجة المتوقعة بناءً على قوة أداء الفرق (الأهداف).

    مهمتك كـ "استراتيجي":
    1.  **اشرح الموقف:** ابدأ بتقديم كل محلل وماذا يقول. "محلل السوق يرى كذا..."، "بينما المحلل الإحصائي يتوقع كذا...".
    2.  **ابحث عن الإشارة الأقوى (الاتفاق):** أهم جزء في عملك هو تحديد نقاط الاتفاق. إذا اتفق المحللان (مثلاً كلاهما يرشح نفس الفريق)، فهذه إشارة قوية جدًا. أبرزها بقوة.
    3.  **حدد مناطق الشك (الاختلاف):** إذا اختلف المحللان، اشرح سبب الاختلاف (مثلاً: السوق يرى شيئًا لا تعكسه الإحصائيات الحالية). هنا يجب أن تنصح بالحذر الشديد أو بتجنب المباراة.
    4.  **قدم نصيحة استراتيجية:** بناءً على الموقف، قدم نصيحة خبير. صحح خطأ شائعًا (مثال: "خطأ شائع هو الرهان على فريق كبير لمجرد أن اسمه كبير وسعره منخفض. يجب أن يكون هناك قيمة حقيقية").
    5.  **أعط رأيك النهائي:** بناءً على كل ما سبق، قدم خلاصتك ورأيك الأخير كـ "استراتيجي".

    استخدم لغة واثقة، واضحة، وقدم تحليلك في شكل فقرات منظمة مع عناوين وإيموجيز.

    البيانات:
    ```json
    {json_blob}
    ```
    """
    
    response = model.generate_content(prompt, generation_config={"temperature": temperature})
    return response.text
